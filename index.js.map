{"version":3,"file":"index.js","sources":["index.mjs"],"sourcesContent":["export const ENTER = 'enter';\nexport const EXIT  = 'exit';\nexport const TEXT  = 'text';\nexport const PI    = 'pi';\nexport const COMMENT = 'comment';\n\nvar _document = document;\nvar _parser = new DOMParser();\nvar _serializer = new XMLSerializer();\n\nexport function fromString(text) {\n    if (!text) {\n        return undefined;\n    }\n    const xml = _parser.parseFromString(text, 'application/xml').documentElement;\n    if (xml.nodeName === 'parsererror') {\n        throw new Error('Error parsing text');\n    }\n    return xml;\n}\n\nexport function toString(xml, options) {\n    options = Object.assign({}, options);\n    let xmltext = _serializer.serializeToString(xml);\n    if (options.xmlDeclaration) {\n        xmltext = \"<?xml version='1.0' encoding='utf-8'?>\\n\" + xmltext;\n    }\n    return xmltext;\n}\n\nexport function* scan(xml) {\n    yield {\n        type: ENTER,\n        tag: curlyName(xml.namespaceURI, xml.nodeName),\n        attrib: attrib(xml),\n    };\n\n    for (const c of xml.childNodes) {\n        if (c.nodeType === 3) {\n            yield {\n                type: TEXT,\n                text: c.textContent,\n            };\n        } else if (c.nodeType === 1) {\n            yield* scan(c);\n        } else if (c.nodeType === 7) {\n            yield {\n                type: PI,\n                target: c.target,\n                text: c.data,\n            };\n        } else if (c.nodeType === 8) {\n            yield {\n                type: COMMENT,\n                text: c.data,\n            };\n        }\n    }\n\n    yield { type: EXIT };\n}\n\nexport function unscan(events, options) {\n    options = Object.assign({}, options);\n    const qualifier = new Qualifier(options.nsmap);\n    const stack = [];\n    var root;\n    for (const e of events) {\n        if (e.type === ENTER) {\n            const elt = createElement(e.tag, e.attrib, stack[stack.length-1], qualifier);\n            stack.push(elt);\n            if (root === undefined) {\n                root = elt;\n            }\n        } else if (e.type === EXIT) {\n            stack.pop();\n        } else if (e.type === TEXT) {\n            stack[stack.length - 1].appendChild(_document.createTextNode(e.text));\n        } else if (e.type === PI) {\n            stack[stack.length - 1].appendChild(_document.createProcessingInstruction(e.target, e.text));\n        } else if (e.type === COMMENT) {\n            stack[stack.length - 1].appendChild(_document.createComment(e.text));\n        } else {\n            throw new Error('Unexpected event type ' + e.type);\n        }\n    }\n\n    if (stack.length !== 0) {\n        throw new Error('unbalanced tags in stream');\n    }\n\n    return root;\n}\n\nclass Qualifier {\n    constructor(nsmap) {\n        this._id = 0;\n        nsmap = Object.assign({}, nsmap);\n        this._nsindex = {};\n        for (const [key, value] of Object.entries(nsmap)) {\n            this._nsindex[value] = key;\n        }\n    }\n\n    qualify(namespaceURI, name) {\n        if (!namespaceURI) {\n            return name;  // nothing to qualify\n        }\n        var prefix = this._nsindex[namespaceURI];\n        if (prefix === undefined) {\n            prefix = 'ns' + this._id;\n            this._nsindex[namespaceURI] = prefix;\n            this._id += 1;\n        } else if (prefix === 'default' || prefix === null || prefix === '') {\n            return name;\n        }\n        return prefix + ':' + name;\n    }\n}\n\nfunction curlyName(namespaceURI, name) {\n    if (namespaceURI) {\n        const parts = name.split(':');\n        return '{' + namespaceURI + '}' + parts[parts.length - 1];\n    } else {\n        return name;\n    }\n}\n\nfunction parseCurlyName(name) {\n    const match = name.match(/^{(.+)}(.+)$/);\n    if (match) {\n        return {\n            namespaceURI: match[1],\n            nodeName: match[2]\n        };\n    } else {\n        return {\n            nodeName: name\n        };\n    }\n}\n\nfunction createElement(tag, attrib, parent, qualifier) {\n    const { namespaceURI, nodeName } = parseCurlyName(tag);\n    const elt = _document.createElementNS(namespaceURI, qualifier.qualify(namespaceURI, nodeName));\n\n    if (parent) {\n        parent.append(elt);\n    }\n\n    for (const name of Object.keys(Object.assign({}, attrib))) {\n        const { namespaceURI, nodeName } = parseCurlyName(name);\n        const attr = _document.createAttributeNS(namespaceURI, qualifier.qualify(namespaceURI, nodeName));\n        if (attrib[name] !== undefined) {\n            attr.value = attrib[name];\n            elt.setAttributeNode(attr);\n        }\n    }\n\n    return elt;\n}\n\nfunction attrib(elt) {\n    const out = {};\n    for (var i = 0; i < elt.attributes.length; i++) {\n        const attr = elt.attributes[i];\n        if (attr.name === 'xmlns' || attr.name.startsWith('xmlns:')) {\n            continue;\n        }\n        const name = curlyName(attr.namespaceURI, attr.name);\n        out[name] = attr.value;\n    }\n    return out;\n}\n\nexport function* withPeer(events) {\n    const stack = [];\n    for (const e of events) {\n        if (e.type === ENTER) {\n            stack.push(e);\n            yield [e, undefined];\n        } else if (e.type === EXIT) {\n            yield [e, stack.pop()];\n        } else if (e.type === TEXT) {\n            yield [e, undefined];\n        } else if (e.type === PI) {\n            yield [e, undefined];\n        } else if (e.type === COMMENT) {\n            yield [e, undefined];\n        } else {\n            throw new Error('Unexpected event ' + e);\n        }\n    }\n}\n\nexport function textOf(events) {\n    return [...events].filter(x => x.type===TEXT).map(x => x.text).join('');\n}\n"],"names":[],"mappings":"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"}